name: Daily Task API Regression Tests

on:
  schedule:
    - cron: '0 19 * * *'  # Runs daily at 19:00 UTC
  workflow_dispatch: # Allows manual triggering

jobs:
  regression-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Compose
        uses: docker/setup-buildx-action@v3

      - name: Spin up Infrastructure
        env:
          SPLUNK_HEC_TOKEN: ${{ secrets.SPLUNK_HEC_TOKEN }}
          SPLUNK_URL: ${{ secrets.SPLUNK_URL }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # 1. Create a dummy .env so Docker Compose doesn't complain
          touch .env
          
          # 2. Start services
          docker compose up -d db splunk
          
          # 3. Wait for DB using a more robust selector
          echo "Waiting for database to be ready..."
          NEXT_WAIT_TIME=0
          until [ $NEXT_WAIT_TIME -eq 10 ] || docker compose exec -T db pg_isready -U postgres; do
            sleep 3
            NEXT_WAIT_TIME=$((NEXT_WAIT_TIME+1))
          done
          sleep 10
        
      - name: Run Regression Tests
        env:
          SPLUNK_HEC_TOKEN: ${{ secrets.SPLUNK_HEC_TOKEN }}
          SPLUNK_URL: ${{ secrets.SPLUNK_URL }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: development
        run: |
          # The -T flag is critical for CI (it disables pseudo-terminal allocation)
          docker compose run -T --rm api npm run test:ci -- --json --outputFile=test-results.json || true
      
      - name: Generate Failure Summary
        if: failure()
        run: |
          # Principal move: Parse the failure to make the email useful
          # This assumes your docker-compose maps the current directory to the container
          SUMMARY=$(jq -r '.testResults[] | select(.status=="failed") | .name' test-results.json | head -n 5)
          echo "FAILED_TESTS<<EOF" >> $GITHUB_ENV
          echo "$SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send Email on Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üö® CRITICAL: Daily Regression Failed - Task API"
          to: nagarajsarath@gmail.com
          from: GitHub Actions - Sarath
          body: |
            The Daily Regression Test for Task API has FAILED.
            
            üîç TOP FAILURES:
            ${{ env.FAILED_TESTS }}
            
            Check the full logs and coverage here: 
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Environment: ${{ github.ref_name }}

      - name: Cleanup
        if: always() # This MUST be last
        run: docker-compose down